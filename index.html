<html>
  <head>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="application.css">
    <link rel="stylesheet" href="jquery-ui/css/smoothness/jquery-ui-1.8.23.custom.css">
    <script src="jquery-1.8.0.min.js"></script>
    <script src="jquery-ui/js/jquery-ui-1.8.23.custom.min.js"></script>
    <script src="date.js"></script>
    <script src="moment.js"></script>
    <script src="jsrender.js"></script>
    <script src="periods.js"></script>
    <script src="planner.js"></script>
    <script src="calendar.js"></script>
  </head>
  <body>

  <div class="container">
    <div id="planner"> </div>
    <div id="calendarWidget"> </div>
  </div>

  <script type="text/javascript">
(function($) {
  $.templates({
    applicationCreateDialog: "<div class='create-dialog'>Hello, world!</div>",
  });

  window.CreateDialog = function(selection) {
    var self = this;

    var dialog = $($.render.applicationCreateDialog(selection)).dialog({
      title: 'Create',
      modal: true,
      position: [300,200],
      width: 600,
      height: 400,
      buttons: {
        Cancel: function() {
          dialog.dialog('close');
        },
        Ok: function() {
          dialog.dialog('close');
        }
      }
    });
  }

})(jQuery);
  </script>
  
  <script type="text/javascript">
  $(function() {
    var starting = Date.parse('1/7/2011');
    var ending = Date.parse('1/1/2015');
    var period = { days: 14 };
    var years = Periods.createYears(starting, ending, period);
    var width = 7;

    var rows = [];
    for (var i = 0; i * width < years.periods.length; ++i) {
      var periods = years.periods.slice(i * width, i * width + width);
      var columns = periods.map(function(p) {
        return p;
      })
      while (columns.length < width) {
        columns.push({
          title: ''
        });
      }
      rows.push({ columns: columns });
    }

    var model = {
      rows: rows
    };
    var dom = $('#calendarWidget');
    var widget = new CalendarWidget(dom, width, model);
    dom.on("cw:selected", function(e, data) {
      new CreateDialog(data);
    });

    console.log(model);
    console.log(years);

    function findPeriodOnOrAfter(date) {
      var found = [];
      $.each(years.periods, function(i, k) {
        if (k.starting.toDate().isBefore(date) || k.starting.toDate().equals(date)) {
          found.push(k);
        }
      });
      return found[found.length - 1];
    }

    var data = $('#data').text().trim();
    var lines = data.split("\n");
    $.each(lines, function(i, line) {
      var fields = line.split("\t");
      var dates = fields[2].split("-");
      var name = fields[0];
      var starting = findPeriodOnOrAfter(Date.parse(dates[0]));
      var ending = findPeriodOnOrAfter(Date.parse(dates[1]));
      console.log(name, dates, starting, ending);
      widget.add({ s: starting.index, e: ending.index, title: name });
    });
  });
  </script>

  <script type="application/foo" id="data">
Borrowed	 Enabled	 2011/01/07 - 2042/01/01
Core	 Enabled	 2011/01/07 - 2042/01/01
Home	 Enabled	 2012/05/01 - 2013/02/01
LA	 Enabled	 2012/08/01 - 2013/08/01
Loan #1	 Enabled	 2012/05/01 - 2012/08/01
Loan #2	 Enabled	 2012/08/01 - 2013/08/01
Loan #3	 Enabled	 2013/08/01 - 2042/01/01
Renting	 Enabled	 2011/01/07 - 2012/05/01
Saving #1	 Enabled	 2012/05/01 - 2014/01/01
Saving #2	 Enabled	 2014/01/01 - 2042/01/01
  </script>
  </body>
</html>
